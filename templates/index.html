<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Threat Analyzer</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;500;600;700&family=Orbitron:wght@400;700&family=Rajdhani:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Updated primary glow color to be more blue */
            --primary-glow-color: #00aeff; /* Clearer Blue */
            --primary-glow-color-rgb: 0, 174, 255;

            --secondary-glow-color: #ff00ff;
            --secondary-glow-color-rgb: 255, 0, 255;
            
            --background-start: #05101c;
            --background-mid: #0d1c33;
            --background-end: #162a4a;

            --text-color: #e6f1ff;
            --text-muted-color: #a8b2d1;
            --card-bg: rgba(20, 40, 65, 0.65);
            --card-border: rgba(var(--primary-glow-color-rgb), 0.25);
            --input-bg: rgba(10, 25, 47, 0.5);
            --button-bg: var(--primary-glow-color);
            --button-text: #0a192f; /* Dark text for better contrast on new blue */
            --button-hover-bg: #0095e0; /* Slightly darker hover for new blue */
            --progress-bar-bg: var(--primary-glow-color);
            --tooltip-bg: #233554;
            --tooltip-text: var(--primary-glow-color);

            /* Threat score colors */
            --threat-low: #4caf50; /* Green */
            --threat-medium: #ff9800; /* Orange */
            --threat-high: #f44336; /* Red */
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--background-start);
            background-image:
                radial-gradient(ellipse at 15% 25%, rgba(var(--primary-glow-color-rgb), 0.12), transparent 50%),
                radial-gradient(ellipse at 85% 75%, rgba(var(--secondary-glow-color-rgb), 0.08), transparent 50%),
                linear-gradient(135deg, var(--background-start), var(--background-mid), var(--background-end));
            background-size: 100% 100%, 100% 100%, auto;
            background-attachment: fixed;
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        h2 {
            margin-top: 40px;
            font-family: 'Orbitron', sans-serif;
            font-size: 2.8rem;
            color: var(--primary-glow-color);
            text-shadow: 0 0 7px var(--primary-glow-color), 0 0 12px rgba(var(--primary-glow-color-rgb), 0.4), 0 0 2px rgba(255,255,255,0.6);
            letter-spacing: 2px;
            text-align: center; /* Ensure it centers well */
        }

        form {
            margin: 30px 0 40px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        input[type="text"] {
            padding: 14px 18px;
            font-size: 1rem;
            width: 300px;
            max-width: 90%;
            background: var(--input-bg);
            border: 1px solid var(--card-border);
            color: #fff;
            border-radius: 8px;
            outline: none;
            backdrop-filter: blur(8px);
            box-shadow: 0 0 5px rgba(var(--primary-glow-color-rgb), 0.1) inset, 0 0 2px rgba(var(--primary-glow-color-rgb), 0.05);
            transition: border-color 0.3s, box-shadow 0.3s;
            caret-color: var(--primary-glow-color);
            font-family: 'Rajdhani', sans-serif;
        }

        input[type="text"]::placeholder {
            color: var(--text-muted-color);
        }

        input[type="text"]:focus {
            border-color: var(--primary-glow-color);
            box-shadow: 0 0 8px rgba(var(--primary-glow-color-rgb), 0.2) inset, 0 0 5px rgba(var(--primary-glow-color-rgb), 0.15);
        }

        input[type="text"]:-webkit-autofill,
        input[type="text"]:-webkit-autofill:hover,
        input[type="text"]:-webkit-autofill:focus,
        input[type="text"]:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 40px var(--input-bg) inset !important;
            -webkit-text-fill-color: #fff !important;
            caret-color: var(--primary-glow-color) !important;
            transition: background-color 5000s ease-in-out 0s;
        }
        input[type="text"]:-moz-autofill {
            box-shadow: 0 0 0 40px var(--input-bg) inset !important;
            -moz-text-fill-color: #fff !important;
        }

        button[type="submit"] {
            padding: 14px 25px;
            font-size: 1rem;
            font-weight: 600;
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Rajdhani', sans-serif;
            box-shadow: 0 0 7px rgba(var(--primary-glow-color-rgb), 0.5), 0 0 3px rgba(var(--primary-glow-color-rgb), 0.3);
        }

        button[type="submit"]:hover {
            background-color: var(--button-hover-bg);
            box-shadow: 0 0 10px rgba(var(--primary-glow-color-rgb), 0.6), 0 0 6px rgba(var(--primary-glow-color-rgb), 0.4);
            transform: translateY(-2px);
        }

        .progress-container {
            width: 80%;
            max-width: 500px;
            height: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            margin-bottom: 30px;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--primary-glow-color), var(--secondary-glow-color));
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
            box-shadow: 0 0 4px rgba(var(--primary-glow-color-rgb),0.5), 0 0 6px rgba(var(--secondary-glow-color-rgb),0.5);
        }
        
        .reports-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 25px;
            width: 100%;
            max-width: 1200px;
            padding: 0 10px;
            margin-bottom: 40px;
        }

        .section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 25px;
            width: 100%;
            max-width: 350px;
            flex: 1 1 300px;
            box-shadow: 0 0 12px rgba(var(--primary-glow-color-rgb), 0.08), 0 0 6px rgba(0,0,0,0.15) inset;
            backdrop-filter: blur(10px);
            /* position: relative; REMOVED - not needed here anymore due to card-header-flex */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-top: 3px solid var(--primary-glow-color);
            display: flex; 
            flex-direction: column;
            font-family: 'Exo 2', sans-serif;
        }

        .section:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 0 18px rgba(var(--primary-glow-color-rgb), 0.12), 0 0 10px rgba(var(--primary-glow-color-rgb), 0.05), 0 0 7px rgba(0,0,0,0.1) inset;
        }
        
        /* New Flex Container for Card Header */
        .card-header-flex {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Align items to the top */
            margin-bottom: 15px; /* Space below header */
            gap: 10px; /* Gap between title and buttons if title is short */
        }

        .section h3 {
            font-family: 'Orbitron', sans-serif;
            color: var(--primary-glow-color);
            margin-top: 0;
            margin-bottom: 0; /* Adjusted, spacing now handled by card-header-flex */
            font-size: 1.4rem;
            text-shadow: 0 0 4px rgba(var(--primary-glow-color-rgb), 0.6);
            flex-grow: 1; /* Allow title to take available space */
            word-break: break-word; /* Allow long titles to wrap */
        }

        .report-summary {
            color: var(--text-muted-color);
            font-size: 1.05rem;
            line-height: 1.6;  
            margin-bottom: 18px;
            border-left: 3px solid var(--secondary-glow-color);
            padding-left: 12px;
            font-weight: 400;
        }

        .section p { 
            color: var(--text-color);
            font-size: 1rem;
            line-height: 1.7; 
            margin-bottom: 12px;
            font-weight: 400;
        }

        .section p strong {
            color: var(--primary-glow-color);
            font-weight: 600;
            margin-right: 8px;
        }

        .action-buttons-header {
            /* position: absolute; REMOVED */
            /* top: 15px; REMOVED */
            /* right: 15px; REMOVED */
            display: flex;
            gap: 8px;
            z-index: 5;
            flex-shrink: 0; /* Prevent buttons from shrinking */
        }

        .copy-btn, .copy-md-btn {
            background-color: rgba(var(--primary-glow-color-rgb), 0.1);
            color: var(--primary-glow-color);
            border: 1px solid rgba(var(--primary-glow-color-rgb), 0.3);
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s, transform 0.2s, border-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .copy-btn svg, .copy-md-btn svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }
        
        .copy-btn:hover, .copy-md-btn:hover {
            background-color: var(--primary-glow-color);
            color: var(--button-text);
            border-color: var(--primary-glow-color);
        }
        .copy-btn:active, .copy-md-btn:active {
            transform: scale(0.92);
        }

        .copy-md-btn {
            background-color: rgba(var(--secondary-glow-color-rgb), 0.1);
            color: var(--secondary-glow-color);
            border-color: rgba(var(--secondary-glow-color-rgb), 0.3);
        }
        .copy-md-btn:hover {
            background-color: var(--secondary-glow-color);
            color: var(--button-text);
            border-color: var(--secondary-glow-color);
        }

        .copy-btn::after, .copy-md-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--tooltip-bg);
            color: var(--tooltip-text);
            padding: 6px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out, transform 0.2s ease-in-out;
            pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .copy-btn:hover::after, .copy-md-btn:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-5px);
        }

        /* Styles for Threat Score Progress Bars */
        .threat-score-container {
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        .threat-score-container p {
            margin-bottom: 5px; /* Smaller margin for text above bar */
            font-size: 0.9em;
            color: var(--text-muted-color);
        }
        .threat-score-container p strong {
            color: var(--text-color); /* Make label slightly more prominent */
        }
        .threat-progress {
            width: 100%;
            height: 10px; /* Slightly taller for better visibility */
            background-color: rgba(0, 0, 0, 0.35); /* Darker background */
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid rgba(var(--primary-glow-color-rgb), 0.1); /* Subtle border */
        }
        .threat-progress-bar {
            height: 100%;
            border-radius: 4px; /* Match outer radius if desired, or slightly less */
            transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
            box-shadow: inset 0 0 2px rgba(0,0,0,0.2); /* Inner shadow for depth */
        }
        /* End Threat Score Progress Bar Styles */


        .section .view-report-link {
            margin-top: auto; 
            align-self: flex-start; 
            padding-top: 15px; 
        }

        .section .view-report-link button {
            padding: 8px 15px;
            font-size: 0.9rem;
            font-weight: 600;
            background-color: transparent;
            color: var(--primary-glow-color);
            border: 1px solid var(--primary-glow-color);
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s ease;
            text-transform: uppercase;
            font-family: 'Rajdhani', sans-serif;
        }

        .section .view-report-link button:hover {
            background-color: var(--primary-glow-color);
            color: var(--button-text);
            box-shadow: 0 0 8px rgba(var(--primary-glow-color-rgb), 0.5);
        }

        @media (max-width: 768px) {
            h2 {
                font-size: 2.2rem;
            }
            form {
                flex-direction: column;
            }
            input[type="text"] {
                width: 80%;
            }
            button[type="submit"] {
                width: 80%;
                margin-top: 10px;
            }
            .reports-container {
                flex-direction: column;
                align-items: center;
            }
            .section {
                 max-width: 90%;
            }
            .card-header-flex {
                /* Could stack title and buttons on small screens if needed */
                /* flex-direction: column; 
                   align-items: flex-start; */
            }
            .action-buttons-header {
                /* margin-top: 10px; if stacking */
            }
        }
         @media (max-width: 480px) {
            h2 {
                font-size: 1.8rem;
            }
            /* Adjust button size and card header for very small screens if title is too long */
            .card-header-flex {
                align-items: center; /* Center items vertically for better look if title wraps */
            }
            .section h3 {
                font-size: 1.2rem; /* Slightly smaller title */
            }
            .action-buttons-header {
                /* top: 10px; REMOVED */
                /* right: 10px; REMOVED */
            }
            .copy-btn, .copy-md-btn {
                width: 28px;
                height: 28px;
            }
            .copy-btn svg, .copy-md-btn svg {
                width: 14px;
                height: 14px;
            }
         }

    </style>
</head>
<body>
    <h2><span style="filter: drop-shadow(0 0 1px rgba(255,255,255,0.6));">🌌</span> IP Threat Analyzer <span style="filter: drop-shadow(0 0 1px rgba(255,255,255,0.6));">🛰️</span></h2>

    <form method="post" id="analyze-form">
        <input type="text" name="ip" placeholder="Enter IP address" required value="{{ ip or '' }}">
        <button type="submit">Analyze</button>
    </form>

    <div class="progress-container" id="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
    </div>

    <div class="reports-container">
        {% if report.abuseipdb %}
            <div class="section" id="abuseipdb-section">
                <div class="card-header-flex">
                    <h3>🛡️ AbuseIPDB Report</h3>
                    <div class="action-buttons-header">
                        <button class="copy-btn" data-tooltip="Copy" onclick="copyText('abuseipdb-text', this, '{{ report.abuseipdb.link }}')">
                            <svg viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>
                        </button>
                        <button class="copy-md-btn" data-tooltip="Copy as MD" onclick="copyTextAsMarkdown('abuseipdb-text', this, '{{ report.abuseipdb.link }}')">
                            <svg viewBox="0 0 16 16"><path d="M10.478 1.647a.5.5 0 1 0-.956-.294l-4 13a.5.5 0 0 0 .956.294l4-13zM4.854 4.146a.5.5 0 0 1 0 .708L1.707 8l3.147 3.146a.5.5 0 0 1-.708.708l-3.5-3.5a.5.5 0 0 1 0-.708l3.5-3.5a.5.5 0 0 1 .708 0zm6.292 0a.5.5 0 0 0 0 .708L14.293 8l-3.147 3.146a.5.5 0 0 0 .708.708l3.5-3.5a.5.5 0 0 0 0-.708l3.5-3.5a.5.5 0 0 0-.708 0z"/></svg>
                        </button>
                    </div>
                </div>
                
                {% if report.abuseipdb.abuseConfidenceScore is defined and report.abuseipdb.totalReports is defined %}
                <div class="threat-score-container">
                    <p><strong>Confidence Score:</strong> {{ report.abuseipdb.abuseConfidenceScore }}% ({{ report.abuseipdb.totalReports }} reports)</p>
                    <div class="threat-progress">
                        {% set score = report.abuseipdb.abuseConfidenceScore %}
                        {% set bar_color = 'var(--threat-low)' %} {# Default to low #}
                        {% if score > 75 %}
                            {% set bar_color = 'var(--threat-high)' %}
                        {% elif score > 25 %}
                            {% set bar_color = 'var(--threat-medium)' %}
                        {% endif %}
                        <div class="threat-progress-bar" style="width: {{ score }}%; background-color: {{ bar_color }};"></div>
                    </div>
                </div>
                {% endif %}

                <div id="abuseipdb-text">
                    <p class="report-summary">{{ report.abuseipdb.summary }}</p>
                    <p><strong>ISP:</strong> {{ report.abuseipdb.isp }}</p>
                    <p><strong>Location:</strong> {{ report.abuseipdb.location }}</p>
                    <p><strong>Usage:</strong> {{ report.abuseipdb.usage }}</p>
                </div>
                <a href="{{ report.abuseipdb.link }}" target="_blank" rel="noopener noreferrer" class="view-report-link">
                    <button type="button">View Full Report</button>
                </a>
            </div>
        {% endif %}

        {% if report.virustotal %}
            <div class="section" id="virustotal-section">
                <div class="card-header-flex">
                    <h3>🔬 VirusTotal Report</h3>
                    <div class="action-buttons-header">
                        <button class="copy-btn" data-tooltip="Copy" onclick="copyText('virustotal-text', this, '{{ report.virustotal.link }}')">
                            <svg viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>
                        </button>
                        <button class="copy-md-btn" data-tooltip="Copy as MD" onclick="copyTextAsMarkdown('virustotal-text', this, '{{ report.virustotal.link }}')">
                            <svg viewBox="0 0 16 16"><path d="M10.478 1.647a.5.5 0 1 0-.956-.294l-4 13a.5.5 0 0 0 .956.294l4-13zM4.854 4.146a.5.5 0 0 1 0 .708L1.707 8l3.147 3.146a.5.5 0 0 1-.708.708l-3.5-3.5a.5.5 0 0 1 0-.708l3.5-3.5a.5.5 0 0 1 .708 0zm6.292 0a.5.5 0 0 0 0 .708L14.293 8l-3.147 3.146a.5.5 0 0 0 .708.708l3.5-3.5a.5.5 0 0 0 0-.708l3.5-3.5a.5.5 0 0 0-.708 0z"/></svg>
                        </button>
                    </div>
                </div>

                {% if report.virustotal.malicious is defined and report.virustotal.total is defined %}
                <div class="threat-score-container">
                    <p><strong>Detection Rate:</strong> {{ report.virustotal.malicious }} / {{ report.virustotal.total }}</p>
                    <div class="threat-progress">
                        {% set malicious_count = report.virustotal.malicious | int %}
                        {% set total_s = report.virustotal.total | int %}
                        {% set vt_percentage = (malicious_count / total_s * 100) if total_s > 0 else 0 %}
                        {% set bar_color = 'var(--threat-low)' %} {# Default to low/none #}
                        {% if malicious_count > 2 %}
                            {% set bar_color = 'var(--threat-high)' %}
                        {% elif malicious_count > 0 %}
                            {% set bar_color = 'var(--threat-medium)' %}
                        {% endif %}
                        <div class="threat-progress-bar" style="width: {{ vt_percentage | round | int }}%; background-color: {{ bar_color }};"></div>
                    </div>
                </div>
                {% endif %}

                <div id="virustotal-text">
                    <p class="report-summary">{{ report.virustotal.summary }}</p>
                    <p><strong>AS Owner:</strong> {{ report.virustotal.as_owner }}</p>
                    <p><strong>Location:</strong> {{ report.virustotal.country }}</p>
                </div>
                <a href="{{ report.virustotal.link }}" target="_blank" rel="noopener noreferrer" class="view-report-link">
                    <button type="button">View Full Report</button>
                </a>
            </div>
        {% endif %}

        {% if report.ipapi %}
            <div class="section" id="ipapi-section">
                 <div class="card-header-flex">
                    <h3>🌐 IP-API Report</h3>
                    <div class="action-buttons-header">
                        <button class="copy-btn" data-tooltip="Copy" onclick="copyText('ipapi-text', this, '{{ report.ipapi.link }}')">
                            <svg viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>
                        </button>
                        <button class="copy-md-btn" data-tooltip="Copy as MD" onclick="copyTextAsMarkdown('ipapi-text', this, '{{ report.ipapi.link }}')">
                            <svg viewBox="0 0 16 16"><path d="M10.478 1.647a.5.5 0 1 0-.956-.294l-4 13a.5.5 0 0 0 .956.294l4-13zM4.854 4.146a.5.5 0 0 1 0 .708L1.707 8l3.147 3.146a.5.5 0 0 1-.708.708l-3.5-3.5a.5.5 0 0 1 0-.708l3.5-3.5a.5.5 0 0 1 .708 0zm6.292 0a.5.5 0 0 0 0 .708L14.293 8l-3.147 3.146a.5.5 0 0 0 .708.708l3.5-3.5a.5.5 0 0 0 0-.708l3.5-3.5a.5.5 0 0 0-.708 0z"/></svg>
                        </button>
                    </div>
                </div>
                <div id="ipapi-text">
                    <p class="report-summary">{{ report.ipapi.summary }}</p>
                    <p><strong>ISP:</strong> {{ report.ipapi.isp }}</p>
                    <p><strong>City:</strong> {{ report.ipapi.city }}</p>
                    <p><strong>Country:</strong> {{ report.ipapi.country }}</p>
                    <p><strong>Proxy:</strong> {{ report.ipapi.proxy }}</p>
                    <p><strong>Hosting:</strong> {{ report.ipapi.hosting }}</p>
                </div>
                <a href="{{ report.ipapi.link }}" target="_blank" rel="noopener noreferrer" class="view-report-link">
                    <button type="button">View Full Report</button>
                </a>
            </div>
        {% endif %}
    </div>

    <script>
        function copyText(elementId, buttonElement, linkHref) {
            const element = document.getElementById(elementId);
            if (!element) {
                console.error("Element not found for copy: ", elementId);
                return;
            }
            
            let textToCopy = "";
            const paragraphs = element.querySelectorAll('p');
            paragraphs.forEach(p => {
                textToCopy += p.innerText + "\n";
            });
            textToCopy = textToCopy.trim();

            if (linkHref) {
                textToCopy += `\n\nView Full Report: ${linkHref}`;
            }

            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalTooltip = buttonElement.getAttribute('data-tooltip'); // Store original
                buttonElement.setAttribute('data-tooltip', 'Copied!');
                setTimeout(() => {
                     buttonElement.setAttribute('data-tooltip', originalTooltip); // Restore original
                }, 1500);
            }).catch(err => {
                console.error("Failed to copy: ", err);
                const originalTooltip = buttonElement.getAttribute('data-tooltip'); // Store original
                 buttonElement.setAttribute('data-tooltip', 'Failed!');
                 setTimeout(() => {
                     buttonElement.setAttribute('data-tooltip', originalTooltip); // Restore original
                 }, 1500);
            });
        }

        function copyTextAsMarkdown(elementId, buttonElement, linkHref) {
            const element = document.getElementById(elementId);
            if (!element) {
                console.error("Element not found for MD copy: ", elementId);
                return;
            }

            let markdownText = "";
            
            const childParagraphs = element.querySelectorAll('p');

            childParagraphs.forEach(p => {
                if (p.classList.contains('report-summary')) {
                    markdownText += "- " + p.innerText.trim() + "\n";
                } else {
                    const strongTag = p.querySelector('strong');
                    if (strongTag) {
                        const label = strongTag.innerText.replace(':', '').trim();
                        const value = p.innerText.replace(strongTag.innerText, '').trim();
                        markdownText += `   - **${label}:** ${value}\n`;
                    } else { 
                        markdownText += p.innerText.trim() + "\n"; 
                    }
                }
            });

            markdownText = markdownText.trim(); 

            if (linkHref) {
                markdownText += `\n   - [View Full Report](${linkHref})`;
            }

            navigator.clipboard.writeText(markdownText).then(() => {
                const originalTooltipText = buttonElement.getAttribute('data-tooltip');
                buttonElement.setAttribute('data-tooltip', 'Copied MD!');
                setTimeout(() => {
                    buttonElement.setAttribute('data-tooltip', originalTooltipText);
                }, 1500);
            }).catch(err => {
                console.error("Failed to copy as Markdown: ", err);
                const originalTooltipText = buttonElement.getAttribute('data-tooltip');
                buttonElement.setAttribute('data-tooltip', 'Failed MD!');
                 setTimeout(() => {
                    buttonElement.setAttribute('data-tooltip', originalTooltipText);
                }, 1500);
            });
        }

        const analyzeForm = document.getElementById('analyze-form');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');

        if (analyzeForm) {
            analyzeForm.addEventListener('submit', function(event) {
                const ipInput = analyzeForm.querySelector('input[name="ip"]');
                if (!ipInput || !ipInput.value.trim()) {
                    // If you want to prevent form submission for empty IP, uncomment:
                    // event.preventDefault(); 
                    // alert("Please enter an IP address.");
                    return; 
                }

                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                let width = 0;
                const intervalTime = 150; 
                const increment = 10; 
                
                // Simulate progress, clear if it goes beyond (should be stopped by server response in a real app)
                const interval = setInterval(() => {
                    width += increment; 
                    if (width <= 100) {
                        progressBar.style.width = width + '%';
                    }
                    if (width >=100) { 
                        clearInterval(interval);
                        // Optionally hide progress bar after a delay if form submission is quick
                        // setTimeout(() => { progressContainer.style.display = 'none'; }, 500);
                    }
                }, intervalTime); 
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const reportsContainer = document.querySelector('.reports-container');
            // If there are reports, and progress is full, hide the main progress bar.
            // This is a simple client-side check. Server-side rendering should ideally not show it if results are present.
            if (reportsContainer && reportsContainer.children.length > 0) {
                 if (progressBar.style.width === '100%') { // Or some other condition indicating completion
                    // progressContainer.style.display = 'none'; // Keep it if still loading, hide if truly done.
                 }
            } else {
                // If no reports, ensure progress bar is hidden unless a submission is active
                 if (progressBar.style.width === '0%') {
                    // progressContainer.style.display = 'none'; // Already hidden by default CSS
                 }
            }
             // Ensure "Copy" / "Copy as MD" is the default tooltip text
            document.querySelectorAll('.copy-btn').forEach(btn => btn.setAttribute('data-tooltip', 'Copy'));
            document.querySelectorAll('.copy-md-btn').forEach(btn => btn.setAttribute('data-tooltip', 'Copy as MD'));
        });
    </script>
</body>
</html>